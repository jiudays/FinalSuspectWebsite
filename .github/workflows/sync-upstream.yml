name: Sync Upstream Code

on:
  schedule:
    - cron: '0 4 * * *'   # æ¯å¤© UTC æ—¶é—´ 4:00 (åŒ—äº¬æ—¶é—´ 12:00)
  workflow_dispatch:        # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write          # å…è®¸å†™å…¥ä»£ç å’Œåˆ›å»º tag

jobs:
  sync:
    runs-on: ubuntu-latest
    
    # æ­¥éª¤1ï¼šè®¾ç½®é‡è¯•ç­–ç•¥ï¼ˆæœ€å¤šå°è¯•3æ¬¡ï¼‰
    strategy:
      max-parallel: 1      # ä¸²è¡Œæ‰§è¡Œï¼Œé¿å…å†²çª
      fail-fast: false      # å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­å°è¯•
    
    steps:
      # æ­¥éª¤2ï¼šæ£€å‡ºä»£ç 
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # æ­¥éª¤3ï¼šé…ç½® Git ç”¨æˆ·
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      # æ­¥éª¤4ï¼šæ·»åŠ ä¸Šæ¸¸ä»“åº“
      - name: Add Upstream Remote
        run: |
          git remote remove upstream 2>/dev/null || true
          git remote add upstream https://github.com/NewLezaiYa/FinalSuspectWebsite.git
          git fetch upstream
      
      # æ­¥éª¤5ï¼šæ£€æµ‹å¹¶å°è¯•åŒæ­¥ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
      - name: Sync with Upstream (with retry)
        id: sync
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          MAX_RETRIES=3
          RETRY_COUNT=0
          SYNC_SUCCESS=false
          
          # å…ˆæ£€æµ‹æ˜¯å¦æœ‰æ›´æ–°
          BEHIND_COUNT=$(git rev-list --count HEAD..upstream/$CURRENT_BRANCH 2>/dev/null || echo "0")
          
          if [ "$BEHIND_COUNT" -eq "0" ]; then
            echo "âœ… å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€åŒæ­¥"
            echo "has_updates=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_updates=true" >> $GITHUB_OUTPUT
          echo "ğŸ”„ å‘ç°ä¸Šæ¸¸æœ‰ $BEHIND_COUNT ä¸ªæ–°æäº¤ï¼Œå¼€å§‹åŒæ­¥ï¼ˆæœ€å¤šé‡è¯• $MAX_RETRIES æ¬¡ï¼‰"
          
          # å¼€å§‹é‡è¯•å¾ªç¯
          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SYNC_SUCCESS" = false ]; do
            RETRY_COUNT=$((RETRY_COUNT+1))
            
            if [ $RETRY_COUNT -gt 1 ]; then
              echo "ğŸ”„ ç¬¬ $RETRY_COUNT æ¬¡é‡è¯•..."
              sleep 5  # é‡è¯•å‰ç­‰å¾…5ç§’
              git fetch upstream  # é‡æ–°è·å–æœ€æ–°çŠ¶æ€
            fi
            
            # å°è¯•åˆå¹¶
            if git merge --no-edit upstream/$CURRENT_BRANCH; then
              # å°è¯•æ¨é€
              if git push origin $CURRENT_BRANCH; then
                SYNC_SUCCESS=true
                echo "âœ… ç¬¬ $RETRY_COUNT æ¬¡å°è¯•æˆåŠŸåŒæ­¥"
                echo "sync_success=true" >> $GITHUB_OUTPUT
              else
                echo "âŒ ç¬¬ $RETRY_COUNT æ¬¡æ¨é€å¤±è´¥"
                # å›é€€åˆå¹¶
                git reset --hard HEAD@{1}
              fi
            else
              echo "âŒ ç¬¬ $RETRY_COUNT æ¬¡åˆå¹¶å¤±è´¥"
              # ä¸­æ­¢åˆå¹¶
              git merge --abort
            fi
          done
          
          # å¦‚æœæœ€ç»ˆå¤±è´¥ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯
          if [ "$SYNC_SUCCESS" = false ]; then
            echo "âŒ æ‰€æœ‰ $MAX_RETRIES æ¬¡å°è¯•å‡å¤±è´¥"
            echo "sync_success=false" >> $GITHUB_OUTPUT
            
            # è·å–é”™è¯¯æ—¶é—´
            ERROR_TIME=$(date '+%Y-%m-%d_%H:%M:%S')
            echo "error_time=$ERROR_TIME" >> $GITHUB_OUTPUT
            
            # è·å–é”™è¯¯è¯¦æƒ…
            {
              echo "error_details<<EOF"
              echo "åŒæ­¥å¤±è´¥æ—¶é—´: $ERROR_time"
              echo "å¤±è´¥æ¬¡æ•°: $MAX_RETRIES"
              echo "å½“å‰åˆ†æ”¯: $CURRENT_BRANCH"
              echo "ä¸Šæ¸¸ä»“åº“: [UPSTREAM-OWNER]/[UPSTREAM-REPO]"
              echo "è½åæäº¤æ•°: $BEHIND_COUNT"
              echo ""
              echo "Git çŠ¶æ€:"
              git status --short
              echo ""
              echo "æœ€è¿‘æäº¤:"
              git log -3 --oneline
              EOF
            } >> $GITHUB_OUTPUT
          fi
      
      # æ­¥éª¤6ï¼šå¦‚æœåŒæ­¥å¤±è´¥ï¼Œåˆ›å»ºé”™è¯¯æ—¥å¿—å¹¶æ‰“ tag
      - name: Create Error Tag and Log
        if: steps.sync.outputs.sync_success == 'false' && steps.sync.outputs.has_updates == 'true'
        run: |
          # åˆ›å»ºæ—¥å¿—ç›®å½•
          mkdir -p error-logs
          
          # ç”Ÿæˆæ—¥å¿—æ–‡ä»¶åï¼ˆä½¿ç”¨ä¼ å…¥çš„æ—¶é—´ï¼‰
          LOG_FILE="error-logs/${{ steps.sync.outputs.error_time }}.log"
          
          # å†™å…¥é”™è¯¯è¯¦æƒ…
          cat > "$LOG_FILE" << 'EOF'
          ${{ steps.sync.outputs.error_details }}
          EOF
          
          # æäº¤æ—¥å¿—æ–‡ä»¶
          git add "$LOG_FILE"
          git commit -m "chore: add error log for failed sync at ${{ steps.sync.outputs.error_time }}"
          
          # åˆ›å»ºé”™è¯¯ tagï¼ˆæ ¼å¼ï¼šaction_error/YYYY-MM-DD_HH-MM-SSï¼‰
          TAG_NAME="action_error/${{ steps.sync.outputs.error_time }}"
          git tag -a "$TAG_NAME" -m "Sync failed at ${{ steps.sync.outputs.error_time }}"
          
          # æ¨é€æäº¤å’Œ tag
          git push origin HEAD --tags
          
          echo "ğŸ“ é”™è¯¯æ—¥å¿—å·²åˆ›å»º: $LOG_FILE"
          echo "ğŸ·ï¸ é”™è¯¯æ ‡ç­¾å·²åˆ›å»º: $TAG_NAME"
      
      # æ­¥éª¤7ï¼šå¯é€‰ - å‘é€å¤±è´¥é€šçŸ¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
      - name: Send Failure Notification
        if: failure() || (steps.sync.outputs.sync_success == 'false' && steps.sync.outputs.has_updates == 'true')
        run: |
          echo "âš ï¸ åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ error-logs ç›®å½•ä¸‹çš„æ—¥å¿—æ–‡ä»¶å’Œ action_error tag"
          # å¦‚æœéœ€è¦é‚®ä»¶é€šçŸ¥ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 